on:
  workflow_call:
    inputs:
      module:
        type: string
        required: true
        description: "Name of the Maven module to build"

permissions: { }

jobs:
  build-native-image:
    name: Build Native Image
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch:
        - name: amd64
          build-timeout: 15
        - name: arm64
          build-timeout: 75
      fail-fast: true
    steps:
    - name: Checkout Repository
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # tag=v4.1.1
    - name: Set up JDK
      uses: actions/setup-java@387ac29b308b003ca37ba93a6cab5eb57c8f5f93 # tag=v4.0.0
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven
    - name: Set up QEMU
      uses: docker/setup-qemu-action@68827325e0b33c7199eb31dd4e31fbe9023e06e3 # tag=v3.0.0
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # tag=v3.0.0
      with:
        install: true
    - name: Build Native Image
      timeout-minutes: ${{ matrix.arch.build-timeout }}
      run: |-
        RESOURCES_INCLUDES=""
        RESOURCES_EXCLUDES=""
        if [[ "${{ matrix.arch.name }}" == "arm64" ]]; then
          # When depending on Kafka Streams, include RocksDB JNI library for aarch64.
          # Quarkus only includes the x64 library variant per default.
          # https://github.com/quarkusio/quarkus/issues/30545
          if grep -i 'kafka-streams' ${{ inputs.module }}/pom.xml > /dev/null; then
            RESOURCES_INCLUDES="librocksdbjni-linux-aarch64.so"
            RESOURCES_EXCLUDES="librocksdbjni-linux64.so"
          fi
        
          # When snappy compression is enabled, include the respective JNI library
          # for aarch64 when building for arm64. Quarkus only includes the x64 library variant per default.
          if grep -i 'quarkus.kafka.snappy.enabled=true' ${{ inputs.module }}/src/main/resources/application.properties > /dev/null; then
            RESOURCES_INCLUDES="$RESOURCES_INCLUDES,org/xerial/snappy/native/Linux/aarch64/libsnappyjava.so"
            RESOURCES_EXCLUDES="$RESOURCES_EXCLUDES,org/xerial/snappy/native/Linux/x86_64/libsnappyjava.so"
          fi
        fi
        echo "Including resources: ${RESOURCES_INCLUDES:-None}"
        echo "Excluding resources: ${RESOURCES_EXCLUDES:-None}"
        mvn clean package -Pnative -pl commons,commons-kstreams,commons-persistence,proto,${{ inputs.module }} -DskipTests \
          -Dquarkus.native.builder-image=quay.io/quarkus/ubi-quarkus-mandrel-builder-image:23.0-java17 \
          -Dquarkus.native.container-build=true \
          -Dquarkus.native.container-runtime-options='--platform=linux/${{ matrix.arch.name }}' \
          -Dquarkus.native.resources.includes="$RESOURCES_INCLUDES" \
          -Dquarkus.native.resources.excludes="$RESOURCES_EXCLUDES"
    - name: Test Native Image
      if: ${{ matrix.arch.name == 'amd64' }}
      run: |-
        mvn -pl commons,commons-kstreams,commons-persistence,proto,${{ inputs.module }} test-compile failsafe:integration-test -Pnative
    - name: Upload Build Artifact
      uses: actions/upload-artifact@c7d193f32edcb7bfad88892161225aeda64e9392 # tag=v4.0.0
      with:
        name: native-image-${{ matrix.arch.name }}
        path: |-
          ${{ inputs.module }}/target/*-runner

  build-container-image:
    name: Build Container Image
    runs-on: ubuntu-latest
    permissions:
      packages: write # Required to push images to ghcr.io
    timeout-minutes: 5
    needs:
    - build-native-image
    steps:
    - name: Checkout Repository
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # tag=v4.1.1
    - name: Download amd64 Binary
      uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # tag=v3.0.2
      with:
        name: native-image-amd64
        path: ${{ inputs.module }}/target/amd64
    - name: Download arm64 Binary
      uses: actions/download-artifact@9bc31d5ccc31df68ecc42ccf4149144866c47d8a # tag=v3.0.2
      with:
        name: native-image-arm64
        path: ${{ inputs.module }}/target/arm64
    - name: Set up QEMU
      uses: docker/setup-qemu-action@68827325e0b33c7199eb31dd4e31fbe9023e06e3 # tag=v3.0.0
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@f95db51fddba0c2d1ec667646a06c2ce06100226 # tag=v3.0.0
      with:
        install: true
    - name: Docker login
      uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # tag=v3.0.0
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ secrets.GITHUB_TOKEN }}
    - name: Determine Container Tags
      id: determine-container-tags
      run: |-
        VERSION="$(yq -p=xml '.project.version' pom.xml)"
        TAGS="ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/hyades-${{ inputs.module }}:${VERSION}-native"
        if [[ $VERSION == *-SNAPSHOT ]]; then
          TAGS="${TAGS},ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/hyades-${{ inputs.module }}:snapshot-native"
        else
          TAGS="${TAGS},ghcr.io/${GITHUB_REPOSITORY_OWNER,,}/hyades-${{ inputs.module }}:latest-native"
        fi
        echo "tags=${TAGS}" >> $GITHUB_OUTPUT
    - name: Build Container Image
      uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # tag=v5.1.0
      with:
        context: ./${{ inputs.module }}
        file: ./${{ inputs.module }}/src/main/docker/Dockerfile.native-multiarch
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.determine-container-tags.outputs.tags }}
