version: "3"

services:
  redpanda:
    image: docker.redpanda.com/vectorized/redpanda:v22.3.1
    container_name: redpanda
    command:
      - redpanda
      - start
      - --smp
      - '1'
      - --reserve-memory
      - 0M
      - --overprovisioned
      - --node-id
      - '0'
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:29092,OUTSIDE://localhost:9092
      - --pandaproxy-addr
      - PLAINTEXT://0.0.0.0:28082,OUTSIDE://0.0.0.0:8082
      - --advertise-pandaproxy-addr
      - PLAINTEXT://redpanda:28082,OUTSIDE://localhost:8082
    ports:
      # Kafka API
      - "127.0.0.1:9092:9092"
      # Schema Registry
      - "127.0.0.1:28081:8081"
      # Pandaproxy (REST API)
      - "127.0.0.1:28082:8082"
    restart: unless-stopped
  init:
    image: docker.redpanda.com/vectorized/redpanda:v22.3.1
    depends_on:
      - redpanda
    entrypoint: [ '/bin/sh', '-c' ]
    command: |
      "
      /usr/bin/rpk cluster health --watch --brokers=redpanda:29092
      echo -e 'Creating topics now'
      /usr/bin/rpk topic create component-analysis --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-analysis-cpe --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-analysis-purl --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-analysis-purl-aggregate --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-analysis-swid --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-analysis-vuln --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000 
      /usr/bin/rpk topic create component-vuln-analysis-result --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create vuln-result --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create configuration-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create datasource_mirroring-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create repository-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create integration-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create analyzer-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create bom_consumed-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create bom_processed-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create file_system-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create indexing_service-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create new_vulnerability-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create new_vulnerable_dependency-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create policy_violation-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create project_audit_change-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create vex_consumed-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create vex_processed-notification --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000

      "
    ports:
      - "8093:8093"
  redpanda-console:
    image: docker.redpanda.com/vectorized/console:v2.0.3
    container_name: redpanda-console
    depends_on:
      - redpanda
    environment:
      KAFKA_BROKERS: "redpanda:29092"
    ports:
      - "127.0.0.1:28080:8080"
    restart: unless-stopped
