version: "3"

services:
  notification-publisher:
    image: ghcr.io/mehab/notification-publisher:latest
    depends_on:
      - postgres
      - redpanda
    environment:
      QUARKUS_KAFKA_STREAMS_BOOTSTRAP_SERVERS: "dt-redpanda:29092"
      QUARKUS_DATASOURCE_JDBC_URL: "jdbc:postgresql://dt-postgres:5432/dtrack"
      QUARKUS_DATASOURCE_USERNAME: "dtrack"
      QUARKUS_DATASOURCE_PASSWORD: "dtrack"
    profiles:
      - demo
    restart: unless-stopped

  repo-meta-analyzer:
    image: ghcr.io/mehab/repository-meta-analyzer:latest
    depends_on:
      - postgres
      - redpanda
    environment:
      QUARKUS_KAFKA_STREAMS_BOOTSTRAP_SERVERS: "dt-redpanda:29092"
      QUARKUS_DATASOURCE_JDBC_URL: "jdbc:postgresql://dt-postgres:5432/dtrack"
      QUARKUS_DATASOURCE_USERNAME: "dtrack"
      QUARKUS_DATASOURCE_PASSWORD: "dtrack"
    profiles:
      - demo
    restart: unless-stopped

  vuln-analyzer:
    image: ghcr.io/mehab/vulnerability-analyzer:latest
    depends_on:
      - postgres
      - redpanda
    environment:
      QUARKUS_KAFKA_STREAMS_BOOTSTRAP_SERVERS: "dt-redpanda:29092"
      QUARKUS_DATASOURCE_JDBC_URL: "jdbc:postgresql://dt-postgres:5432/dtrack"
      QUARKUS_DATASOURCE_USERNAME: "dtrack"
      QUARKUS_DATASOURCE_PASSWORD: "dtrack"
      # KAFKA_STREAMS_NUM_STREAM_THREADS: "12"
      SCANNER_OSSINDEX_ENABLED: "true"
      # SCANNER_OSSINDEX_API_USERNAME: "email@example.com"
      # SCANNER_OSSINDEX_API_TOKEN: "your-token"
      # SCANNER_SNYK_ENABLED: "true"
      # SCANNER_SNYK_ORG_ID: "your-org-id"
      # SCANNER_SNYK_TOKEN: "your-token"
    profiles:
      - demo
    restart: unless-stopped

  apiserver:
    build:
      context: ../dependency-track
      dockerfile: src/main/docker/Dockerfile.demo
    container_name: dt-apiserver
    depends_on:
      - postgres
      - redpanda
    environment:
      ALPINE_DATABASE_MODE: "external"
      ALPINE_DATABASE_URL: "jdbc:postgresql://dt-postgres:5432/dtrack"
      ALPINE_DATABASE_DRIVER: "org.postgresql.Driver"
      ALPINE_DATABASE_USERNAME: "dtrack"
      ALPINE_DATABASE_PASSWORD: "dtrack"
      KAFKA_BOOTSTRAP_SERVERS: "dt-redpanda:29092"
    ports:
      - "127.0.0.1:8080:8080"
    profiles:
      - demo
    volumes:
      - "./apiserver-data:/data"
      - "./secret.key:/data/.dependency-track/keys/secret.key:ro"
    restart: unless-stopped

  frontend:
    image: dependencytrack/frontend:snapshot
    environment:
      API_BASE_URL: "http://localhost:8080"
    ports:
      - "127.0.0.1:8081:8080"
    restart: unless-stopped

  postgres:
    image: postgres:14-alpine
    container_name: dt-postgres
    environment:
      POSTGRES_DB: "dtrack"
      POSTGRES_USER: "dtrack"
      POSTGRES_PASSWORD: "dtrack"
    ports:
      - "127.0.0.1:5432:5432"
    volumes:
      - "postgres-data:/var/lib/postgresql/data"
      - "./commons/src/main/resources/migrations/postgres/V0.0.1__API-Server-4.7.0-SNAPSHOT.sql:/docker-entrypoint-initdb.d/001-init.sql"
    restart: unless-stopped

  redpanda:
    image: docker.redpanda.com/vectorized/redpanda:v22.3.4
    container_name: dt-redpanda
    command:
      - redpanda
      - start
      - --smp
      - '1'
      - --reserve-memory
      - 0M
      - --overprovisioned
      - --node-id
      - '0'
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:29092,OUTSIDE://0.0.0.0:9092
      - --advertise-kafka-addr
      - PLAINTEXT://dt-redpanda:29092,OUTSIDE://localhost:9092
      - --pandaproxy-addr
      - PLAINTEXT://0.0.0.0:28082,OUTSIDE://0.0.0.0:8082
      - --advertise-pandaproxy-addr
      - PLAINTEXT://dt-redpanda:28082,OUTSIDE://localhost:8082
    ports:
      # Kafka API
      - "127.0.0.1:9092:9092"
      # Schema Registry (currently not used)
      # - "127.0.0.1:28081:8081"
      # Pandaproxy (REST API, currently not used)
      # - "127.0.0.1:28082:8082"
    volumes:
      - "redpanda-data:/var/lib/redpanda/data"
    restart: unless-stopped

  redpanda-init:
    image: docker.redpanda.com/vectorized/redpanda:v22.3.4
    container_name: dt-redpanda-init
    depends_on:
      - redpanda
    entrypoint: [ '/bin/sh', '-c' ]
    command: |
      "
      /usr/bin/rpk cluster health --watch --brokers=redpanda:29092
      echo -e 'Creating topics now'
      /usr/bin/rpk topic create component-analysis --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-meta-analysis-result --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create repo-meta-analysis --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-meta-analysis-maven --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-meta-analysis-npm --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-meta-analysis-hex --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-meta-analysis-pypi --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-meta-analysis-golang --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-meta-analysis-nuget --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-meta-analysis-composer --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-meta-analysis-gem --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-analysis-cpe --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-analysis-purl --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-analysis-swid --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create component-analysis-vuln --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000 
      /usr/bin/rpk topic create component-vuln-analysis-result --brokers=redpanda:29092 --replicas=1 --partitions=3
      /usr/bin/rpk topic create notification.configuration --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.datasource_mirroring --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.repository --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.integration --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.analyzer --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.bom_consumed --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.bom_processed --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.file_system --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.indexing_service --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.new_vulnerability --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.new_vulnerable_dependency --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.policy_violation --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.project_audit_change --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.vex_consumed --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      /usr/bin/rpk topic create notification.vex_processed --brokers=redpanda:29092 --replicas=1 --partitions=3 --topic-config retention.ms=86400000
      "
    restart: on-failure

  redpanda-console:
    image: docker.redpanda.com/vectorized/console:v2.1.0
    container_name: dt-redpanda-console
    depends_on:
      - redpanda
    environment:
      KAFKA_BROKERS: "redpanda:29092"
    ports:
      - "127.0.0.1:28080:8080"
    restart: unless-stopped

volumes:
  apiserver-data: {}
  postgres-data: {}
  redpanda-data: {}
