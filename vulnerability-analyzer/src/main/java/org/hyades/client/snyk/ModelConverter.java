package org.hyades.client.snyk;

import com.google.protobuf.Timestamp;
import org.hyades.commonutil.JsonUtil;
import org.hyades.model.Cwe;
import org.hyades.proto.vuln.v1.Alias;
import org.hyades.proto.vuln.v1.Rating;
import org.hyades.proto.vuln.v1.Reference;
import org.hyades.proto.vuln.v1.ScoreMethod;
import org.hyades.proto.vuln.v1.Severity;
import org.hyades.proto.vuln.v1.Source;
import org.hyades.proto.vuln.v1.Vulnerability;
import org.hyades.resolver.CweResolver;

import java.time.chrono.ChronoZonedDateTime;
import java.util.Objects;
import java.util.Optional;

public final class ModelConverter {

    private ModelConverter() {
    }

    public static Vulnerability convert(final CweResolver cweResolver, final SeveritySource severitySource, final PageData<Issue> pageData) {
        final Vulnerability.Builder vulnBuilder = Vulnerability.newBuilder();
        vulnBuilder.setId(pageData.id());
        vulnBuilder.setSource(Source.SOURCE_SNYK);
        vulnBuilder.setDescription(pageData.attributes().description());
        Optional.ofNullable(pageData.attributes().createdAt())
                .map(JsonUtil::jsonStringToTimestamp)
                .map(ChronoZonedDateTime::toInstant)
                .map(instant -> Timestamp.newBuilder().setSeconds(instant.getEpochSecond()).build())
                .ifPresent(vulnBuilder::setCreated);
        Optional.ofNullable(pageData.attributes().updatedAt())
                .map(JsonUtil::jsonStringToTimestamp)
                .map(ChronoZonedDateTime::toInstant)
                .map(instant -> Timestamp.newBuilder().setSeconds(instant.getEpochSecond()).build())
                .ifPresent(vulnBuilder::setUpdated);
        if (pageData.attributes().problems() != null) {
            vulnBuilder.addAllAliases(pageData.attributes().problems().stream()
                    .map(ModelConverter::convert)
                    .filter(Objects::nonNull)
                    .toList());
            pageData.attributes().problems().stream()
                    .map(problem -> convert(cweResolver, problem))
                    .filter(Objects::nonNull)
                    .forEach(vulnBuilder::addCwes);
        }
        if (pageData.attributes().severities() != null) {
            pageData.attributes().severities().stream()
                    .filter(severity -> severitySource.equals(severity.source()))
                    .filter(severity -> severity.score() != null && !severity.vector().isBlank())
                    .findFirst()
                    .ifPresent(severity -> vulnBuilder.addRatings(Rating.newBuilder()
                            .setSeverity(switch (severity.level()) {
                                case "CRITICAL" -> Severity.SEVERITY_CRITICAL;
                                case "HIGH" -> Severity.SEVERITY_HIGH;
                                case "MEDIUM" -> Severity.SEVERITY_MEDIUM;
                                case "LOW" -> Severity.SEVERITY_LOW;
                                default -> Severity.SEVERITY_UNKNOWN;
                            })
                            .setMethod(ScoreMethod.SCORE_METHOD_CVSSV3)
                            .setScore(severity.score())
                            .setVector(severity.vector())
                            .build())
                    );
        }
        if (pageData.attributes().slots() != null && pageData.attributes().slots().references() != null) {
            pageData.attributes().slots().references().stream()
                    .map(reference -> Reference.newBuilder()
                            .setUrl(reference.url())
                            .setDisplayName(reference.title()))
                    .forEach(vulnBuilder::addReferences);
        }
        return vulnBuilder.build();
    }

    private static Integer convert(final CweResolver cweResolver, final Problem problem) {
        if ("CWE".equals(problem.source())) {
            return Optional.ofNullable(cweResolver.resolve(problem.id()))
                    .map(Cwe::getCweId)
                    .orElse(null);
        }
        return null;
    }

    private static Alias convert(final Problem problem) {
        return switch (problem.source()) {
            case "CVE" -> Alias.newBuilder()
                    .setId(problem.id())
                    .setSource(Source.SOURCE_NVD)
                    .build();
            case "GHSA" -> Alias.newBuilder()
                    .setId(problem.id())
                    .setSource(Source.SOURCE_GITHUB)
                    .build();
            default -> null;
        };
    }

}
