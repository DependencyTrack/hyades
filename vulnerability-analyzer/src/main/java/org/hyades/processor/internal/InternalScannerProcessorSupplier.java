package org.hyades.processor.internal;

import io.micrometer.core.instrument.MeterRegistry;
import io.quarkus.cache.Cache;
import io.quarkus.cache.CacheName;
import org.hyades.model.VulnerabilityScanResult;
import org.hyades.model.ScanTask;
import org.hyades.persistence.VulnerableSoftwareRepository;
import org.apache.kafka.streams.processor.api.Processor;
import org.apache.kafka.streams.processor.api.ProcessorSupplier;

import javax.enterprise.context.ApplicationScoped;
import javax.inject.Inject;

@ApplicationScoped
public class InternalScannerProcessorSupplier implements ProcessorSupplier<String, ScanTask, String, VulnerabilityScanResult> {

    private final VulnerableSoftwareRepository vulnerableSoftwareRepository;
    private final Cache cache;
    private final MeterRegistry meterRegistry;

    @Inject
    public InternalScannerProcessorSupplier(final VulnerableSoftwareRepository vulnerableSoftwareRepository,
                                            @CacheName("internalCache") final Cache cache,
                                            final MeterRegistry meterRegistry) {
        this.vulnerableSoftwareRepository = vulnerableSoftwareRepository;
        this.cache = cache;
        this.meterRegistry = meterRegistry;
    }

    @Override
    public Processor<String, ScanTask, String, VulnerabilityScanResult> get() {
        return new InternalScannerProcessor(vulnerableSoftwareRepository, cache, meterRegistry);
    }

}
