package org.acme.persistence;

import io.quarkus.test.TestTransaction;
import io.quarkus.test.junit.QuarkusTest;
import org.acme.model.Component;
import org.acme.model.Project;
import org.acme.persistence.ComponentRepository;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import javax.inject.Inject;
import javax.persistence.EntityManager;
import javax.transaction.Transactional;
import java.util.UUID;

@QuarkusTest
class ComponentRepositoryTest {
    @Inject
    EntityManager entityManager;

    @Inject
    ComponentRepository componentRepository;

    @Test
    @Transactional
    public void testGetComponentByUUID() {
        UUID uuid1 = UUID.randomUUID();
        UUID uuid2 = UUID.randomUUID();
        var project = new Project();
        project.setName("acme-app");
        project.setUuid(uuid1);
        entityManager.createNativeQuery("""
                INSERT INTO "PROJECT" ("ID", "NAME", "UUID") VALUES
                                    (1, 'acme-app',:uuid);
                """).setParameter("uuid", uuid1).executeUpdate();

        entityManager.createNativeQuery("""
                INSERT INTO "COMPONENT" ("ID", "NAME", "VERSION", "PURL","UUID", "PROJECT_ID") VALUES
                                    (1, 'github.com/tidwall/gjson', 'v1.6.0', 'pkg:golang/github.com/tidwall/gjson@v1.6.0?type=module', :uuid, 1);
                """).setParameter("uuid", uuid2).executeUpdate();

        final Component component= componentRepository
                .getComponentByUUID(uuid2);
        Assertions.assertEquals(1, component.getId());

    }
}