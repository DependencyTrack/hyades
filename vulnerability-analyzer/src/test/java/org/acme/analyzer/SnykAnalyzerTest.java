package org.acme.analyzer;

import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import io.github.resilience4j.ratelimiter.RateLimiter;
import io.quarkus.cache.CacheManager;
import io.quarkus.cache.CacheName;
import io.quarkus.cache.CaffeineCache;
import io.quarkus.test.junit.QuarkusTest;
import io.quarkus.test.junit.mockito.InjectMock;
import org.acme.client.snyk.Issue;
import org.acme.client.snyk.Page;
import org.acme.client.snyk.SeveritySource;
import org.acme.client.snyk.SnykClient;
import org.acme.model.AnalyzerIdentity;
import org.acme.model.Component;
import org.acme.model.Vulnerability;
import org.acme.model.VulnerabilityResult;
import org.junit.jupiter.api.AfterEach;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;
import io.quarkus.cache.Cache;
import javax.inject.Inject;
import javax.inject.Named;
import javax.ws.rs.WebApplicationException;
import java.io.IOException;
import java.nio.file.Paths;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.CompletableFuture;

@QuarkusTest
class SnykAnalyzerTest {

    @InjectMock
    SnykClient snykClient;

    @Inject
    @Named("snykObjectMapper")
    ObjectMapper objectMapper;

    @Inject
    CacheManager cacheManager;

    @Inject
    SnykAnalyzer snykAnalyzer;

    @Inject
    @CacheName("snyk")
    Cache snykCache;

    @AfterEach
    void afterEach() {
        cacheManager.getCache("snyk").get().invalidateAll().await().indefinitely();
    }

    @BeforeEach
    void beforeEach() {
        cacheManager.getCache("snyk").get().invalidateAll().await().indefinitely();
    }

    @Test
    @SuppressWarnings("unchecked")
    void testIsEnabled() {
        //var analyzer = new SnykAnalyzer(snykClient, Mockito.mock(Cache.class), Mockito.mock(RateLimiter.class), false, SeveritySource.NVD);
        var analyzer = new SnykAnalyzer(snykClient, false, SeveritySource.NVD);
        Assertions.assertFalse(analyzer.isEnabled());

        //analyzer = new SnykAnalyzer(snykClient, Mockito.mock(Cache.class), Mockito.mock(RateLimiter.class), true, SeveritySource.NVD);
        analyzer = new SnykAnalyzer(snykClient, true, SeveritySource.NVD);

        Assertions.assertTrue(analyzer.isEnabled());
    }

    @Test
    void testAnalyzeWithNoComponents() {
        final List<VulnerabilityResult> results = snykAnalyzer.analyze(Collections.emptyList());
        Assertions.assertEquals(0, results.size());
    }

    @Test
    void testAnalyzeWithResults() throws Exception {
        // Have Snyk return two issues for the analyzed component
        Mockito.when(snykClient.getIssues(Mockito.anyString()))
                .thenReturn(getSnykResponseTestData("multiple-issues-response.json"));

        final var component = new Component();
        component.setGroup("com.fasterxml.woodstox");
        component.setName("woodstox-core");
        component.setVersion("5.0.0");
        component.setPurl("pkg:maven/com.fasterxml.woodstox/woodstox-core@5.0.0");
        // Verify that two results are returned
        final List<VulnerabilityResult> results = snykAnalyzer.analyze(List.of(component));
        Assertions.assertEquals(2, results.size());

        final VulnerabilityResult firstResult = results.get(0);
        Assertions.assertEquals(component, firstResult.getComponent());
        Assertions.assertEquals(AnalyzerIdentity.SNYK_ANALYZER, firstResult.getIdentity());
        Assertions.assertNotNull(firstResult.getVulnerability());
        Assertions.assertEquals("SNYK-JAVA-COMFASTERXMLWOODSTOX-3091135", firstResult.getVulnerability().getVulnId());
        Assertions.assertEquals(Vulnerability.Source.SNYK.name(), firstResult.getVulnerability().getSource());

        final VulnerabilityResult secondResult = results.get(1);
        Assertions.assertEquals(component, secondResult.getComponent());
        Assertions.assertEquals(AnalyzerIdentity.SNYK_ANALYZER, secondResult.getIdentity());
        Assertions.assertNotNull(secondResult.getVulnerability());
        Assertions.assertEquals("SNYK-JAVA-COMFASTERXMLWOODSTOX-2928754", secondResult.getVulnerability().getVulnId());
        Assertions.assertEquals(Vulnerability.Source.SNYK.name(), secondResult.getVulnerability().getSource());
    }

    @Test
    void testAnalyzeWithNoResults() throws Exception {
        // Have Snyk return no issues for the analyzed component
        Mockito.when(snykClient.getIssues(Mockito.anyString()))
                .thenReturn(getSnykResponseTestData("no-issues-response.json"));
        final var component = new Component();
        component.setGroup("com.fasterxml.woodstox");
        component.setName("woodstox-core");
        component.setVersion("6.4.0");
        component.setPurl("pkg:maven/com.fasterxml.woodstox/woodstox-core@6.4.0");

        final List<VulnerabilityResult> results = snykAnalyzer.analyze(List.of(component));
        Assertions.assertEquals(1, results.size());

        // Ensure a result with null vulnerability is returned
        final VulnerabilityResult result = results.get(0);
        Assertions.assertEquals(component, result.getComponent());
        Assertions.assertEquals(AnalyzerIdentity.SNYK_ANALYZER, result.getIdentity());
        Assertions.assertNull(result.getVulnerability());
    }

    @Test
    void testCachingWithResults() throws Exception {
        // Have Snyk return two issues for the analyzed component

        Mockito.when(snykClient.getIssues(Mockito.anyString()))
                .thenReturn(getSnykResponseTestData("multiple-issues-response.json"));
        final var component = new Component();
        component.setGroup("com.fasterxml.woodstox");
        component.setName("woodstox-core");
        component.setVersion("5.0.0");
        component.setPurl("pkg:maven/com.fasterxml.woodstox/woodstox-core@5.0.0");
        snykCache.as(CaffeineCache.class).put(component.getPurl().getCoordinates(), CompletableFuture.completedFuture(getSnykResponseTestData("multiple-issues-response.json")));
        // Analyze the same component twice
        Assertions.assertEquals(2, snykAnalyzer.analyze(List.of(component)).size());
        Assertions.assertEquals(2, snykAnalyzer.analyze(List.of(component)).size());

        // Verify that the client was only used once
        Mockito.verify(snykClient, Mockito.atMostOnce()).getIssues(Mockito.anyString());
    }

    @Test
    void testCachingWithNoResults() throws Exception {
        // Have Snyk return no issues for the analyzed component
        Mockito.when(snykClient.getIssues(Mockito.anyString()))
                .thenReturn(getSnykResponseTestData("no-issues-response.json"));

        final var component = new Component();
        component.setGroup("com.fasterxml.woodstox");
        component.setName("woodstox-core");
        component.setVersion("6.4.0");
        component.setPurl("pkg:maven/com.fasterxml.woodstox/woodstox-core@6.4.0");
        // Analyze the same component twice
        Assertions.assertEquals(1, snykAnalyzer.analyze(List.of(component)).size());
        Assertions.assertEquals(1, snykAnalyzer.analyze(List.of(component)).size());

        // Verify that the client was only used once
        Mockito.verify(snykClient, Mockito.atMostOnce()).getIssues(Mockito.anyString());
    }

    @Test
    void testSnykClientException() throws Exception {
        // Have the Snyk client throw an exception
        Mockito.when(snykClient.getIssues(Mockito.anyString()))
                .thenThrow(new WebApplicationException());

        final var component = new Component();
        component.setGroup("com.fasterxml.woodstox");
        component.setName("woodstox-core");
        component.setVersion("6.4.0");
        component.setPurl("pkg:maven/com.fasterxml.woodstox/woodstox-core@6.4.0");

        // Verify the current behavior of just re-throwing the client exception
        // in a RuntimeException.
        Assertions.assertThrows(RuntimeException.class,
                () -> snykAnalyzer.analyze(List.of(component)));
    }

    private Page<Issue> getSnykResponseTestData(final String name) throws IOException {
        return objectMapper.readValue(getClass().getClassLoader().getResource(Paths.get("snyk", name).toString()),
                new TypeReference<>() {
                });
    }

}