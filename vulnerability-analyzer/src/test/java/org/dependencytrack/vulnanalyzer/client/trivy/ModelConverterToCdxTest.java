/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.vulnanalyzer.client.trivy;

import org.cyclonedx.proto.v1_4.Bom;
import org.junit.jupiter.api.Test;

import java.util.List;
import java.util.Map;

import static org.assertj.core.api.Assertions.assertThat;
import static org.cyclonedx.proto.v1_4.ScoreMethod.SCORE_METHOD_CVSSV3;
import static org.cyclonedx.proto.v1_4.Severity.SEVERITY_MEDIUM;

public class ModelConverterToCdxTest {

    @Test
    void testConvert() {
        var trivyVulnerability = new org.dependencytrack.vulnanalyzer.client.trivy.Vulnerability(
                "CVE-2020-7471",
                "com.fasterxml.woodstox/woodstox-core",
                "5.0.0",
                "5.0.3",
                "title",
                "description",
                "MEDIUM",
                List.of("https://access.redhat.com/security/cve/CVE-2022-40152"),
                new  PkgIdentifier<>("pkg:maven/com.fasterxml.woodstox/woodstox-core@5.0.0", null),
                null, "ghsa",
                Map.of("ghsa", new CVSS<>("", "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H", 0, 6.5),
                        "nvd", new CVSS<>("", "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H", 0, 7.5)),
                List.of("CWE-111"),
                "https://avd.aquasec.com/nvd/cve-2022-40152", "2022-09-16T10:15:09.877Z",
                "2023-02-09T01:36:03.637Z", null, null, null,
                new DataSource<>("ghsa", "GitHub Security Advisory Maven", "https://github.com/advisories?query=type%3Areviewed+ecosystem%3Amaven"),
                Map.of("ghsa", "MEDIUM", "nvd", "HIGH"), null, null, 2
        );

        Bom bom = org.dependencytrack.vulnanalyzer.client.trivy.ModelConverterToCdx.convert(List.of(trivyVulnerability));
        assertThat(bom).isNotNull();
        assertThat(bom.getVulnerabilitiesCount()).isEqualTo(1);
        var vulnerability = bom.getVulnerabilities(0);
        assertThat(vulnerability.getId()).isEqualTo("CVE-2020-7471");
        assertThat(vulnerability.getSource().getName()).isEqualTo("NVD");
        assertThat(vulnerability.getRecommendation()).isEqualTo("Fixed version : 5.0.3");
        assertThat(vulnerability.getCwesList()).containsOnly(111);
        assertThat(vulnerability.getPropertiesList()).satisfiesExactly(
                property -> {
                    assertThat(property.getName()).isEqualTo("dependency-track:vuln:title");
                    assertThat(property.getValue()).isEqualTo("title");
                }
        );
        assertThat(vulnerability.getPublished().getSeconds()).isEqualTo(1663323309);
        assertThat(vulnerability.getUpdated().getSeconds()).isEqualTo(1675906563);
        assertThat(vulnerability.getReferencesCount()).isZero();
        assertThat(vulnerability.getRatingsList()).satisfiesExactly(
                rating -> {
                    assertThat(rating.getSource().getName()).isEqualTo("GITHUB");
                    assertThat(rating.getMethod()).isEqualTo(SCORE_METHOD_CVSSV3);
                    assertThat(rating.getScore()).isEqualTo(6.5);
                    assertThat(rating.getSeverity()).isEqualTo(SEVERITY_MEDIUM);
                    assertThat(rating.getVector()).isEqualTo("CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:N/I:N/A:H");
                }
        );
        assertThat(vulnerability.getAdvisoriesList()).satisfiesExactlyInAnyOrder(
                reference -> assertThat(reference.getUrl()).isEqualTo("https://access.redhat.com/security/cve/CVE-2022-40152")
        );
    }
}
