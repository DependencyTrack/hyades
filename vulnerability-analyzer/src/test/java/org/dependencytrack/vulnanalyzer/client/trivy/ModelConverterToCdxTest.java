/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.vulnanalyzer.client.trivy;

import org.cyclonedx.proto.v1_4.Bom;
import org.junit.jupiter.api.Test;

import java.util.List;

import static org.assertj.core.api.Assertions.assertThat;

public class ModelConverterToCdxTest {

    @Test
    void testConvert() {
        var trivyVulnerability = new org.dependencytrack.vulnanalyzer.client.trivy.Vulnerability(
                "CVE-2020-7471",
                "com.fasterxml.woodstox/woodstox-core",
                "5.0.0",
                "5.0.3",
                "title",
                "description",
                null, null, new  PkgIdentifier<>("pkg:maven/com.fasterxml.woodstox/woodstox-core@5.0.0", null),
                null, null, null, List.of("CWE-111"),
                null, null, null, null, null, null,
                null, null, null, null, 2
        );

        Bom bom = org.dependencytrack.vulnanalyzer.client.trivy.ModelConverterToCdx.convert(List.of(trivyVulnerability));
        assertThat(bom).isNotNull();
        assertThat(bom.getVulnerabilitiesCount()).isEqualTo(1);
        var vulnerability = bom.getVulnerabilities(0);
        assertThat(vulnerability.getId()).isEqualTo("CVE-2020-7471");
        assertThat(vulnerability.getSource().getName()).isEqualTo("NVD");
        assertThat(vulnerability.getRecommendation()).isEqualTo("Fixed version : 5.0.3");
        assertThat(vulnerability.getCwesList()).containsOnly(111);
        assertThat(vulnerability.getPropertiesList()).satisfiesExactly(
                property -> {
                    assertThat(property.getName()).isEqualTo("dependency-track:vuln:title");
                    assertThat(property.getValue()).isEqualTo("title");
                }
        );
    }
}
