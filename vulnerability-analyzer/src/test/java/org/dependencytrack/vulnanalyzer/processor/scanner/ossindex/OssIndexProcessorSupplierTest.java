/*
 * This file is part of Dependency-Track.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * SPDX-License-Identifier: Apache-2.0
 * Copyright (c) OWASP Foundation. All Rights Reserved.
 */
package org.dependencytrack.vulnanalyzer.processor.scanner.ossindex;

import org.dependencytrack.proto.vulnanalysis.v1.Component;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.CsvSource;

import java.util.Optional;
import java.util.Set;
import java.util.UUID;

import static org.assertj.core.api.Assertions.assertThat;

class OssIndexProcessorSupplierTest {

    private OssIndexProcessorSupplier processorSupplier;

    @BeforeEach
    void beforeEach() {
        processorSupplier = new OssIndexProcessorSupplier(null, null, null, null,
                null, null, null, null, Set.of(
                "cargo",
                "cocoapods",
                "composer",
                "conan",
                "conda",
                "cran",
                "gem",
                "hex",
                "maven",
                "npm",
                "nuget",
                "pypi",
                "rpm",
                "swift"));
    }

    @ParameterizedTest
    @CsvSource(value = {
            ",,,false", // Nothing set -> No
            "cpe:/a:acme:application:9.1.1,,,false", // Only CPE set -> No
            ",pkg:maven/acme/a@9.1.1,,true", // Only PURL set -> Yes
            "cpe:/a:acme:application:9.1.1,,false,false", // CPE and not internal -> No
            ",pkg:maven/acme/a@9.1.1,false,true", // PURL and not internal -> Yes
            "cpe:/a:acme:application:9.1.1,,true,false", // CPE and internal -> No
            ",pkg:maven/acme/a@9.1.1,true,false", // PURL and internal -> No
            "cpe:/a:acme:application:9.1.1,pkg:maven/acme/a@9.1.1,false,true", // CPE, PURL, and not internal -> Yes
            "cpe:/a:acme:application:9.1.1,pkg:maven/acme/a@9.1.1,true,false" // CPE, PURL, and internal -> No
    })
    void testCanProcess(final String cpe, final String purl, final Boolean internal, final boolean expectedResult) {
        final Component.Builder componentBuilder = Component.newBuilder()
                .setUuid(UUID.randomUUID().toString());
        Optional.ofNullable(cpe).ifPresent(componentBuilder::setCpe);
        Optional.ofNullable(purl).ifPresent(componentBuilder::setPurl);
        Optional.ofNullable(internal).ifPresent(componentBuilder::setInternal);

        assertThat(processorSupplier.canProcess(componentBuilder.build())).isEqualTo(expectedResult);
    }

    @ParameterizedTest
    @CsvSource(value = {
            "bitbucket, false",
            "cargo, true",
            "cocoapods, true",
            "composer, true",
            "conan, true",
            "conda, true",
            "cran, true",
            "deb, false",
            "docker, false",
            "foobar, false",
            "gem, true",
            "generic, false",
            "github, false",
            "golang, false",
            "hex, true",
            "maven, true",
            "npm, true",
            "nuget, true",
            "pypi, true",
            "rpm, true",
            "swift, true",
    })
    void testCanProcessPurlTypes(final String type, final boolean expectedResult) {
        final var component = Component.newBuilder()
                .setUuid(UUID.randomUUID().toString())
                .setPurl("pkg:%s/acme/a@9.1.1".formatted(type))
                .build();
        assertThat(processorSupplier.canProcess(component)).isEqualTo(expectedResult);
    }

}